<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Find Twitch Clips</title>
  <style>
    html body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #000;
      color: #ddd;
      padding: 0;
      margin: 0;
    }

    .navbar {
      position: fixed;
      background-color: #000;
      width: 100%;
      height: 120px;
    }

    .userlogo {
      border-radius: 40px;
      width: 100px;
      position: absolute;
      top: 20px;
      left: 20px;
    }

    .userdesc {
      font-size: 30px;
      color: #999;
      position: absolute;
      top: 23px;
      left: 140px;
    }

    .searchbox, .userbox {
      display: inline-block;
      width: 400px;
      height: 37px;
      background-color: #222;
      border: 1px solid #333;
      border-radius: 10px;
      color: #ddd;
      font-size: 20px;
      padding-left: 10px;
    }

    .searchbox {
      position: absolute;
      left: 140px;
      top: 68px;
    }

    .userbox {
      margin: 20px;
    }

    .user-select .title {
      font-size: 20px;
      color: #ccc;
      margin-left: 20px;
      margin-top: 20px;
    }

    .loading {
      position: absolute;
      left: 140px;
      top: 75px;
    }

    .clipspanel {
      padding-top: 130px;
      padding-left: 20px;
    }

    .clip {
      display: inline-block;
      padding: 10px;
      border: 1px solid #000;
      border-radius: 10px;
      color: #ddd;
    }

    .clip .thumbnail img {
      width: 300px;
    }

    .clip:hover {
      border: 1px solid rgb(34, 44, 54);
      background-color: rgb(22, 25, 28);
      color: #fff;
    }

    .clip .creator {
      color: #777;
    }

    .login-button {
      border-radius: 20px;
      position: absolute;
      left: 50%;
      top: 50%;
      width: 250px;
      transform: translate(-50%, -50%);
      color: #fff;
      text-decoration: none;
      background-color: #8C38F6;
    }

    .login-button .label {
      position: absolute;
      top: 13px;
      left: 65px;
    }

    .twitch-icon {
      margin: 10px 10px 5px 10px;
      fill: #fff;
      width: 30px;
      display: inline;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    const clientID = 'gccrk5tmgyuq326eyvye4zqbf6rt5s';
    const root = document.getElementById('root');

    async function apiCall(url) {
      const res = await fetch(url, {
        headers: {
          Authorization: `Bearer ${token}`,
          'Client-Id': clientID
        }
      });
      return await res.json();
    }

    // Grab the current username from the url
    let username;
    const { hash } = window.location;
    if (hash && !hash.startsWith('#access_token')) {
      username = hash.substring(1);
      window.localStorage.setItem('username', username);
    }

    // Grab the API token from the url if we're coming back from login
    let token = window.localStorage.getItem('token');
    const match = /access_token=([^&]+)/.exec(window.location.hash);
    if (match) {
      window.location.hash = '';
      window.localStorage.setItem('token', match[1]);
      token = match[1];

      // Bring back the selected user if it was present before login
      if (!username) {
        username = window.localStorage.getItem('username');
        if (username) {
          window.location.hash = username;
        }
      }
    }

    if (!token) {
      // No API token, redirect to login page.
      window.location.href = `https://id.twitch.tv/oauth2/authorize?response_type=token&client_id=${clientID}&redirect_uri=${window.location.origin}&scope=`;
    } else {
      if (username) {
        // Load the selected user info
        const { data } = await apiCall(`https://api.twitch.tv/helix/users?login=${username}`, token);
        const user = data[0];

        root.innerHTML = `
          <div class="clips">
            <div class="navbar">
              <a target="_blank" rel="noreferrer" href="https://twitch.tv/${user.login}">
                <img class="userlogo" src="${user.profile_image_url}" alt="${user.display_name}" />
              </a>
              <span class="userdesc">Finding clips for <b>${user.display_name}</b></span>
              <div class="loading">Loading...</div>
              <input class="searchbox" type="text" placeholder="Enter search term" />
            </div>
            <div class="clipspanel"></div>
          </div>`;

        const baseUrl = `https://api.twitch.tv/helix/clips?broadcaster_id=${user.id}&first=100`;
        let url = baseUrl;
        const clips = [];
        let cursor;

        // Load all the clips for the user
        while (true) {
          const result = await apiCall(url, token);
          clips.push(...result.data);
          cursor = result.pagination.cursor;
          if (!cursor) {
            break;
          }
          url = `${baseUrl}&after=${cursor}`;
        }

      }
    }
  </script>

</body>
</html>